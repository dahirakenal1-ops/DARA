<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Membre - Dahira Kenal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #333;
            padding: 10px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        .profile-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 10px;
        }

        .profile-header {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .profile-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid white;
            margin: 0 auto 15px;
            object-fit: cover;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .profile-photo-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid white;
            margin: 0 auto 15px;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .profile-name {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profile-id {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-ok {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .status-late {
            background: rgba(255,255,255,0.3);
            color: #fbbf24;
        }

        .profile-actions {
            margin-top: 15px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: white;
            color: #059669;
        }

        .btn-primary:hover {
            background: #f8fafc;
            transform: translateY(-1px);
        }

        .payments-section {
            padding: 20px;
        }

        .section-title {
            font-size: 1.2rem;
            color: #059669;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .payment-item {
            background: #f8fafc;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #059669;
        }

        .payment-info {
            flex: 1;
        }

        .payment-type {
            font-size: 0.8rem;
            color: #6b7280;
            text-transform: capitalize;
            margin-bottom: 2px;
        }

        .payment-date {
            font-size: 0.9rem;
            color: #374151;
            font-weight: 500;
        }

        .payment-amount {
            font-weight: 600;
            color: #059669;
            font-size: 1rem;
        }

        .payment-total {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .total-info {
            flex: 1;
        }

        .total-label {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .total-count {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .total-amount {
            font-size: 1.4rem;
            font-weight: 700;
            color: white;
        }

        .payments-separator {
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, #e5e7eb 20%, #e5e7eb 80%, transparent 100%);
            margin: 15px 0;
        }

        .loader {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
            flex-direction: column;
            gap: 15px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #059669;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            text-align: center;
            padding: 30px;
            color: #dc2626;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .empty-state {
            text-align: center;
            padding: 30px;
            color: #6b7280;
            font-style: italic;
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .container {
                max-width: 100%;
            }

            .profile-header {
                padding: 15px;
            }

            .profile-photo, .profile-photo-placeholder {
                width: 70px;
                height: 70px;
            }

            .profile-name {
                font-size: 1.2rem;
            }

            .payments-section {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loader" class="loader">
            <div class="spinner"></div>
            <p>Chargement du profil...</p>
        </div>

        <div id="profile-content" style="display: none;">
            <!-- Profile Header -->
            <div class="profile-card">
                <div class="profile-header">
                    <div id="profile-photo-container">
                        <!-- Photo will be inserted here -->
                    </div>
                    <h1 class="profile-name" id="profile-name">Chargement...</h1>
                    <div class="profile-id" id="profile-id">ID: ...</div>
                    <div id="status-container">
                        <!-- Status will be inserted here -->
                    </div>
                    <div class="profile-actions">
                        <a id="call-button" class="btn btn-primary" style="display: none;">
                            üìû Appeler
                        </a>
                    </div>
                </div>
            </div>

            <!-- Payments Section -->
            <div class="profile-card">
                <div class="payments-section">
                    <h2 class="section-title">
                        üí∞ Historique des ADIYA
                    </h2>
                    <div id="payments-container">
                        <!-- Payments will be inserted here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="error-content" style="display: none;">
            <div class="error">
                <h2>‚ùå Erreur</h2>
                <p id="error-message">Impossible de charger le profil du membre.</p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, get, child } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBkcnXxfcw4TN3DSmtUeimJ5br7PuBpqVo",
            authDomain: "dahira-kenal.firebaseapp.com",
            databaseURL: "https://dahira-kenal-default-rtdb.firebaseio.com",
            projectId: "dahira-kenal",
            storageBucket: "dahira-kenal.firebasestorage.app",
            messagingSenderId: "363618938352",
            appId: "1:363618938352:web:307a7e87a9571cf08d4135",
            measurementId: "G-MD6F2PKZZY"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Fonctions utilitaires
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                return dateString;
            }
        }

        function formatCurrency(amount) {
            if (!amount && amount !== 0) return '0 FCFA';
            return `${amount.toLocaleString('fr-FR')} FCFA`;
        }

        function showLoader() {
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('profile-content').style.display = 'none';
            document.getElementById('error-content').style.display = 'none';
        }

        function showProfile() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('profile-content').style.display = 'block';
            document.getElementById('error-content').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('profile-content').style.display = 'none';
            document.getElementById('error-content').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        // Calculer le statut de paiement du membre
        async function getPaymentStatus(memberId, allPayments = null) {
            try {
                let payments = allPayments;

                // Si on n'a pas les paiements, les charger depuis tous les utilisateurs
                if (!payments) {
                    const usersRef = ref(database, 'users');
                    const usersSnapshot = await get(usersRef);

                    if (usersSnapshot.exists()) {
                        const usersData = usersSnapshot.val();
                        payments = [];

                        // Collecter tous les paiements de tous les utilisateurs
                        for (const userId in usersData) {
                            const userData = usersData[userId];
                            if (userData.payments) {
                                if (Array.isArray(userData.payments)) {
                                    // Si c'est un tableau direct
                                    payments = payments.concat(userData.payments);
                                } else {
                                    // Si c'est un objet avec des cl√©s (structure ancienne)
                                    Object.values(userData.payments).forEach(paymentArray => {
                                        if (Array.isArray(paymentArray)) {
                                            payments = payments.concat(paymentArray);
                                        }
                                    });
                                }
                            }
                        }
                    } else {
                        payments = [];
                    }
                }

                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                const memberPayments = payments.filter(p => p && p.memberId === memberId);

                // Calculer les paiements du mois en cours
                const monthlyPayments = memberPayments.filter(p => {
                    const paymentDate = new Date(p.date);
                    return paymentDate.getMonth() === currentMonth &&
                           paymentDate.getFullYear() === currentYear &&
                           p.type === 'mensuelle';
                });

                const weeklyPayments = memberPayments.filter(p => {
                    const paymentDate = new Date(p.date);
                    return paymentDate.getMonth() === currentMonth &&
                           paymentDate.getFullYear() === currentYear &&
                           p.type === 'hebdomadaire';
                });

                // Calculer les montants totaux
                const monthlyTotal = monthlyPayments.reduce((sum, p) => sum + (p.montant || 0), 0);
                const weeklyTotal = weeklyPayments.reduce((sum, p) => sum + (p.montant || 0), 0);

                // D√©terminer le statut
                return (weeklyTotal >= 1000 && monthlyTotal >= 500) ? '√Ä jour' : 'En retard';

            } catch (error) {
                console.error('Erreur lors du calcul du statut des adiya:', error);
                return 'Erreur';
            }
        }

        // Charger les donn√©es du membre
        async function loadMemberProfile(memberId) {
            try {
                showLoader();

                // Chercher dans tous les utilisateurs (puisque les donn√©es sont stock√©es par user)
                const usersRef = ref(database, 'users');
                const usersSnapshot = await get(usersRef);

                if (!usersSnapshot.exists()) {
                    throw new Error('Aucune donn√©e trouv√©e dans la base');
                }

                const usersData = usersSnapshot.val();
                let memberData = null;
                let allPayments = [];

                // Parcourir tous les utilisateurs pour trouver le membre
                for (const userId in usersData) {
                    const userData = usersData[userId];
                    
                    // Chercher le membre dans les donn√©es de cet utilisateur
                    if (userData.membres) {
                        const member = Object.values(userData.membres).find(m => m.id === memberId);
                        if (member) {
                            memberData = member;
                        }
                    }
                    
                    // Collecter tous les paiements de tous les utilisateurs
                    if (userData.payments) {
                        if (Array.isArray(userData.payments)) {
                            // Si c'est un tableau direct
                            allPayments = allPayments.concat(userData.payments);
                        } else {
                            // Si c'est un objet avec des cl√©s (structure ancienne)
                            Object.values(userData.payments).forEach(payment => {
                                if (Array.isArray(payment)) {
                                    allPayments = allPayments.concat(payment);
                                }
                            });
                        }
                    }
                }

                if (!memberData) {
                    throw new Error('Membre introuvable');
                }

                // Calculer le statut avec tous les paiements
                const status = await getPaymentStatus(memberId, allPayments);

                // Afficher les informations du membre
                displayMemberInfo(memberData, memberId, status);

                // Charger les paiements du membre
                await loadMemberPayments(memberId, allPayments);

                showProfile();

            } catch (error) {
                console.error('Erreur lors du chargement du profil:', error);
                showError(error.message || 'Erreur lors du chargement du profil');
            }
        }

        // Afficher les informations du membre
        function displayMemberInfo(memberData, memberId, status) {
            // Photo
            const photoContainer = document.getElementById('profile-photo-container');
            if (memberData.photo && memberData.photo.startsWith('data:image')) {
                photoContainer.innerHTML = `<img src="${memberData.photo}" alt="Photo de ${memberData.prenom} ${memberData.nom}" class="profile-photo">`;
            } else {
                photoContainer.innerHTML = `<div class="profile-photo-placeholder">üë§</div>`;
            }

            // Nom et ID
            document.getElementById('profile-name').textContent = `${memberData.prenom} ${memberData.nom}`;
            document.getElementById('profile-id').textContent = `ID: ${memberId.slice(-6)}`;

            // Statut
            const statusContainer = document.getElementById('status-container');
            const statusClass = status === '√Ä jour' ? 'status-ok' : 'status-late';
            statusContainer.innerHTML = `<span class="status-badge ${statusClass}">${status}</span>`;

            // Bouton d'appel
            const callButton = document.getElementById('call-button');
            if (memberData.telephone) {
                callButton.href = `tel:${memberData.telephone}`;
                callButton.style.display = 'inline-flex';
            } else {
                callButton.style.display = 'none';
            }
        }

        // Charger les paiements du membre
        async function loadMemberPayments(memberId, allPayments = null) {
            try {
                let payments = allPayments;

                // Si on n'a pas les paiements, les charger depuis tous les utilisateurs
                if (!payments) {
                    const usersRef = ref(database, 'users');
                    const usersSnapshot = await get(usersRef);

                    if (usersSnapshot.exists()) {
                        const usersData = usersSnapshot.val();
                        payments = [];

                        // Collecter tous les paiements de tous les utilisateurs
                        for (const userId in usersData) {
                            const userData = usersData[userId];
                            if (userData.payments) {
                                if (Array.isArray(userData.payments)) {
                                    // Si c'est un tableau direct
                                    payments = payments.concat(userData.payments);
                                } else {
                                    // Si c'est un objet avec des cl√©s (structure ancienne)
                                    Object.values(userData.payments).forEach(paymentArray => {
                                        if (Array.isArray(paymentArray)) {
                                            payments = payments.concat(paymentArray);
                                        }
                                    });
                                }
                            }
                        }
                    } else {
                        payments = [];
                    }
                }

                const paymentsContainer = document.getElementById('payments-container');
                paymentsContainer.innerHTML = '';

                const allMemberPayments = [];

                // Filtrer les paiements de ce membre
                payments.forEach(payment => {
                    if (payment && payment.memberId === memberId) {
                        allMemberPayments.push({
                            type: payment.type,
                            date: payment.date,
                            montant: payment.montant,
                            key: payment.id || Date.now().toString()
                        });
                    }
                });

                // Trier par date d√©croissante
                allMemberPayments.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Calculer le total des paiements
                const totalAmount = allMemberPayments.reduce((sum, payment) => sum + (payment.montant || 0), 0);

                if (allMemberPayments.length > 0) {
                    // Afficher le total
                    const totalItem = document.createElement('div');
                    totalItem.className = 'payment-total';
                    totalItem.innerHTML = `
                        <div class="total-info">
                            <div class="total-label">üí∞ Total des ADIYA</div>
                            <div class="total-count">(${allMemberPayments.length} paiement${allMemberPayments.length > 1 ? 's' : ''})</div>
                        </div>
                        <div class="total-amount">${formatCurrency(totalAmount)}</div>
                    `;
                    paymentsContainer.appendChild(totalItem);

                    // S√©parateur
                    const separator = document.createElement('div');
                    separator.className = 'payments-separator';
                    paymentsContainer.appendChild(separator);

                    // R√©cup√©rer la liste des √©v√©nements (si disponible dans la DB)
                    const eventsMap = {};
                    try {
                        const eventsRef = ref(database, 'events');
                        const eventsSnap = await get(eventsRef);
                        if (eventsSnap.exists()) {
                            const evts = eventsSnap.val();
                            // evts peut √™tre un objet ou un tableau
                            if (Array.isArray(evts)) {
                                evts.forEach(e => { if (e && e.id) eventsMap[e.id] = e.title || e.name || e.titre || e.title; });
                            } else {
                                Object.values(evts).forEach(e => { if (e && e.id) eventsMap[e.id] = e.title || e.name || e.titre || e.title; });
                            }
                        } else {
                            // tenter de r√©cup√©rer events sous chaque user
                            const usersRef2 = ref(database, 'users');
                            const usersSnap2 = await get(usersRef2);
                            if (usersSnap2.exists()) {
                                const usersData2 = usersSnap2.val();
                                for (const uid in usersData2) {
                                    const u = usersData2[uid];
                                    if (u.events) {
                                        if (Array.isArray(u.events)) {
                                            u.events.forEach(e => { if (e && e.id) eventsMap[e.id] = e.title || e.name || e.titre; });
                                        } else {
                                            Object.values(u.events).forEach(arr => {
                                                if (Array.isArray(arr)) arr.forEach(e => { if (e && e.id) eventsMap[e.id] = e.title || e.name || e.titre; });
                                            });
                                        }
                                    }
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('Impossible de charger la liste des √©v√©nements:', e);
                    }

                    // Afficher les paiements individuels
                    allMemberPayments.forEach(payment => {
                        const paymentItem = document.createElement('div');
                        paymentItem.className = 'payment-item';

                        // d√©terminer le libell√© √† afficher pour le type (√©v√©nement vs caisse)
                        const rawType = payment.type || '';
                        const isEvent = typeof rawType === 'string' && rawType.startsWith('event-');
                        const displayType = isEvent ? (eventsMap[rawType] || rawType) : rawType;

                        // zone action: remplacer le bouton par un petit logo Wave cliquable
                        const waveUrl = 'https://pay.wave.com/m/M_sn__iXmGOL_WZTs/c/sn/';
                        const waveAction = `<a class="btn btn-primary" href="${waveUrl}" target="_blank" rel="noopener" style="padding:6px 10px; font-size:0.9rem;display:inline-flex;align-items:center;gap:8px;"><img src="wave-mobile-money-logo.avif" alt="Wave" style="width:20px;height:20px;object-fit:contain;">Wave</a>`;

                        paymentItem.innerHTML = `
                            <div class="payment-info">
                                <div class="payment-type">${displayType}</div>
                                <div class="payment-date">${formatDate(payment.date)}</div>
                            </div>
                            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;">
                                <div class="payment-amount">${formatCurrency(payment.montant)}</div>
                                ${waveAction}
                            </div>
                        `;

                        paymentsContainer.appendChild(paymentItem);
                    });
                    // Si le membre est en retard, proposer les ADIYA restants √† payer par Wave
                    const statusBadge = document.querySelector('#status-container .status-badge');
                    const isLate = statusBadge && statusBadge.textContent && statusBadge.textContent.includes('En retard');
                    if (isLate) {
                        // calculer montants restants simples (bas√© sur les seuils utilis√©s)
                        const weeklyPaid = allMemberPayments.filter(p => p.type === 'hebdomadaire').reduce((s,p)=>s+(p.montant||0),0);
                        const monthlyPaid = allMemberPayments.filter(p => p.type === 'mensuelle').reduce((s,p)=>s+(p.montant||0),0);
                        const weeklyRemaining = Math.max(0, 1000 - weeklyPaid);
                        const monthlyRemaining = Math.max(0, 500 - monthlyPaid);

                        const remainingSection = document.createElement('div');
                        remainingSection.style.marginTop = '12px';
                        remainingSection.innerHTML = `
                            <div style="font-weight:700; margin-bottom:8px; color:#b91c1c;">‚ö†Ô∏è ADIYA restants</div>
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                ${weeklyRemaining > 0 ? `<div style="background:#fff7ed;padding:10px;border-radius:8px;display:flex;align-items:center;gap:8px;"><div>Hebdomadaire: <strong>${formatCurrency(weeklyRemaining)}</strong></div><a class="btn btn-primary" href="https://pay.wave.com/m/M_sn__iXmGOL_WZTs/c/sn/" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:8px;"><img src="wave-mobile-money-logo.avif" alt="Wave" style="width:18px;height:18px;object-fit:contain;">Payer</a></div>` : ''}
                                ${monthlyRemaining > 0 ? `<div style="background:#fff7ed;padding:10px;border-radius:8px;display:flex;align-items:center;gap:8px;"><div>Mensuelle: <strong>${formatCurrency(monthlyRemaining)}</strong></div><a class="btn btn-primary" href="https://pay.wave.com/m/M_sn__iXmGOL_WZTs/c/sn/" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:8px;"><img src="wave-mobile-money-logo.avif" alt="Wave" style="width:18px;height:18px;object-fit:contain;">Payer</a></div>` : ''}
                            </div>
                        `;
                        paymentsContainer.appendChild(remainingSection);
                    }
                } else {
                    paymentsContainer.innerHTML = `
                        <div class="empty-state">
                            <p>üìù Aucun ADIYA enregistr√©</p>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Erreur lors du chargement des ADIYA:', error);
                document.getElementById('payments-container').innerHTML = `
                    <div class="error">
                        <p>‚ùå Erreur lors du chargement des ADIYA</p>
                    </div>
                `;
            }
        }

        // Fonction principale
        function init() {
            // R√©cup√©rer l'ID du membre depuis l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const memberId = urlParams.get('id');

            if (!memberId) {
                showError('ID du membre manquant dans l\'URL');
                return;
            }

            // Charger le profil
            loadMemberProfile(memberId);
        }

        // D√©marrer l'application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>